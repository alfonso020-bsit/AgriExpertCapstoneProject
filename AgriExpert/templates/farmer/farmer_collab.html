{% extends 'farmer/base_farmer.html' %}

{% comment %} {% extends 'farmer/base_farmer.html' %}

{% block content %}
<div class="container mt-4">
    <h2 class="text-center fw-bold">ðŸ“© Inbox</h2>

    {% if conversations %}
        {% for expert, messages in conversations.items %}
            <div class="card mb-3">
                <div class="card-header d-flex align-items-center">
                    <img src="{{ expert.profile_image.url }}" alt="{{ expert.first_name }}" class="rounded-circle me-2" width="40" height="40">
                    <h5 class="mb-0">{{ expert.first_name }} {{ expert.last_name }}</h5>
                </div>
                <div class="card-body">
                    <div class="chat-box p-3 border rounded bg-light" style="height: 300px; overflow-y: auto;">
                        {% for message in messages %}
                            <div class="d-flex {% if message.sender_farmer.id == request.session.user_id %}justify-content-end{% else %}justify-content-start{% endif %}">
                                <div class="p-2 mb-2 rounded {% if message.sender_farmer.id == request.session.user_id %}bg-success text-white{% else %}bg-secondary text-white{% endif %}">
                                    <p class="mb-0"><strong>{% if message.sender_farmer.id == request.session.user_id %}You{% else %}{{ expert.first_name }}{% endif %}:</strong> {{ message.message_text }}</p>
                                    {% if message.image %}
                                        <img src="{{ message.image }}" alt="Sent Image" class="img-fluid mt-2" style="max-width: 200px;">
                                    {% endif %}
                                    <small class="d-block text-end">{{ message.timestamp|date:"M d, Y - H:i" }}</small>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    <form method="POST" enctype="multipart/form-data" action="{% url 'send_message' expert.id %}" class="mt-3">
                        {% csrf_token %}
                        <div class="input-group">
                            <textarea name="message" class="form-control" rows="1" required placeholder="Type a message..."></textarea>
                            <input type="file" name="image" class="form-control">
                            <button type="submit" class="btn btn-success">Send</button>
                        </div>
                    </form>
                </div>
            </div>
        {% endfor %}
    {% else %}
        <p class="text-center text-muted">No conversations yet.</p>
    {% endif %}
</div>
{% endblock %} {% endcomment %}

{% comment %} {% block content %}
<div class="container mt-4">
    <h2>Inbox</h2>
    <div class="list-group">
        {% for item in expert_messages %}
        <a href="{% url 'chat_detail' item.expert.id %}" class="list-group-item list-group-item-action d-flex align-items-center">
            <img src="{{ item.expert.profile_picture }}" alt="{{ item.expert.first_name }}" class="rounded-circle me-3" width="50" height="50">
            <div>
                <strong>{{ item.expert.first_name }} {{ item.expert.last_name }}</strong><br>
                {% if item.latest_message %}
                    {% if item.latest_message.sender_farmer.id == request.session.user_id %}
                        You: 
                    {% else %}
                        {{ item.expert.first_name }}: 
                    {% endif %}
                    {{ item.latest_message.message_text|truncatechars:50 }}
                {% else %}
                    No messages yet
                {% endif %}
            </div>
        </a>
        {% empty %}
        <p>No conversations yet.</p>
        {% endfor %}
    </div>
</div>
{% endblock %} {% endcomment %}
{% block content %}
<div class="container mt-4">
    <h2>Inbox</h2>
    <div class="list-group">
        {% for item in expert_messages %}
        <a href="{% url 'chat_detail' item.expert.id %}" 
           class="list-group-item list-group-item-action d-flex align-items-center 
           {% if item.latest_message and item.latest_message.sender_expert and not item.latest_message.is_read %} fw-bold {% endif %}">
            <img src="{{ item.expert.profile_picture }}" alt="{{ item.expert.first_name }}" 
                 class="rounded-circle me-3" width="50" height="50">
            <div>
                <strong>{{ item.expert.first_name }} {{ item.expert.last_name }}</strong><br>
                {% if item.latest_message %}
                    {% if item.latest_message.sender_farmer.id == request.session.user_id %}
                        You: 
                    {% else %}
                        {{ item.expert.first_name }}: 
                    {% endif %}
                    {{ item.latest_message.message_text|truncatechars:50 }}
                {% else %}
                    No messages yet
                {% endif %}
            </div>
        </a>
        {% empty %}
        <p>No conversations yet.</p>
        {% endfor %}
    </div>
</div>
{% endblock %}
