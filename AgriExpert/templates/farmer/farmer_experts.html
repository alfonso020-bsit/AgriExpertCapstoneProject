{% extends 'farmer/base_farmer.html' %}

{% block content %}
<div class="container mt-4">
    <h2 class="text-center fw-bold">Mga Ekspertong Aprubado</h2>

    <!-- Horizontal Scrollable Expert List -->
    <div class="expert-scroll-container d-flex align-items-center">
        {% for expert in approved_experts %}
            <div class="expert-card text-center approved">
                <div class="profile-container">
                    <img src="{{ expert.profile_picture }}" class="rounded-circle expert-profile">
                    <span class="badge verified-badge"><i class="fas fa-check-circle"></i></span>
                </div>

                <div class="expert-details">
                    <strong>{{ expert.first_name }}{% if expert.middle_name %} {{ expert.middle_name }}{% endif %} {{ expert.last_name }}</strong>
                    <br>
                    <small>{{ expert.position }}</small>
                </div>

                <!-- Clickable Link to View Profile -->
                <a href="{% url 'view_expertfromfarmer' expert.id %}" class="btn btn-primary mt-2">
                    Tingnan ang Profile
                </a>
                <!-- Message Button -->
                {% if expert.id in existing_chat_experts %}
                <a href="{% url 'chat_detail' expert.id %}" class="btn btn-success mt-2">
                    I-Message
                </a>
                {% else %}
                <a href="{% url 'send_message' expert.id %}" class="btn btn-success mt-2">
                    I-Message
                </a>
                {% endif %}
            </div>
        {% empty %}
        <p class="text-center mt-4">Walang aprubadong eksperto sa ngayon.</p>
        {% endfor %}
    </div>
</div>
 <!-- Posts by Experts (Remains responsive via Bootstrap) -->
<h3 class="text-center mt-5">Mga Post ng Eksperto</h3>
<div class="feed-container">
    {% for post in expert_posts %}
    <div class="feed-post mb-4 shadow-sm p-3 rounded bg-white">
        <div class="post-header d-flex align-items-center mb-3">
            <img src="{{ post.expert.profile_picture }}" class="post-profile rounded-circle me-2">
            <div>
                <strong>{{ post.expert.first_name }} {{ post.expert.last_name }}</strong><br>
                <small class="text-muted">Posted on {{ post.created_at }}</small>
            </div>
        </div>

        <h5 class="fw-bold">{{ post.title }}</h5>
        <p class="caption-text">{{ post.caption|linebreaksbr }}</p>

        {% with post.get_images as images %}
            {% if images|length == 1 %}
                <img src="{{ images.0.image_url }}" class="img-fluid rounded mb-2 single-image" alt="Post Image">
            {% elif images|length > 1 and images|length <= 4 %}
                <div class="row g-2">
                    {% for image in images %}
                        <div class="col-6 col-md-4">
                            <img src="{{ image.image_url }}" class="img-fluid rounded multi-image" alt="Post Image">
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <div class="post-actions mt-3 d-flex flex-wrap gap-2">
            <a href="{% url 'view_post' post.id %}" class="btn btn-outline-primary btn-sm">üîç View Post</a>
            <button class="upvote-button btn btn-outline-secondary btn-sm"
                    data-post-id="{{ post.id }}"
                    style="{% if post.already_upvoted %}background-color:rgb(44, 163, 50);{% endif %}">
                üëç <span class="upvote-count">{{ post.get_upvotes_count }}</span>
            </button>
            <a href="{% url 'view_post' post.id %}#comment-form" class="comment-btn">
                üí¨ Comment
            </a>
        </div>

        <div class="comments mt-3">
            {% if post.solution_comment %}
                <div class="mb-2 p-2 bg-light rounded">
                    <div class="d-flex align-items-start">
                        <img src="{{ post.solution_comment.expert.profile_picture }}" class="rounded-circle me-2" alt="Expert Profile" style="width: 40px; height: 40px; object-fit: cover; border: 2px solid #28a745;">
                        <div>
                            <strong>
                                {{ post.solution_comment.expert.first_name }} {{ post.solution_comment.expert.last_name }}
                                <span class="badge bg-success ms-2">‚úî Solusyon</span>
                            </strong>
                            <small class="text-muted d-block">‚Ä¢ {{ post.solution_comment.created_at|date:"M d, Y H:i" }}</small>
                            <p style="text-align: justify;" class="mb-0">
                                {{ post.solution_comment.content|linebreaksbr }}
                            </p>
                        </div>
                    </div>
                </div>
            {% else %}
                {% for comment in post.get_comments %}
                <div class="mb-2 p-2 bg-light rounded">
                    <div class="d-flex align-items-start">
                        <img src="{{ comment.expert.profile_picture }}" class="rounded-circle me-2" alt="Expert Profile" style="width: 40px; height: 40px; object-fit: cover; border: 2px solid #28a745;">
                        <div>
                            <strong>{{ comment.expert.first_name }} {{ comment.expert.last_name }}</strong>
                            <small class="text-muted d-block">‚Ä¢ {{ comment.created_at|date:"M d, Y H:i" }}</small>
                            <p style="text-align: justify;" class="mb-0">
                                {{ comment.content|linebreaksbr }}
                            </p>
                        </div>
                    </div>
                </div>
                {% empty %}
                    <p class="text-muted">Wala pang komento sa post na ito.</p>
                {% endfor %}
            {% endif %}
        </div>

        {% if request.session.role == "Eksperto" and request.session.user_id %}
        <form method="POST" action="{% url 'comment_post' post.id %}" class="mt-3">
            {% csrf_token %}
            <div class="mb-2">
                <textarea name="content" class="form-control" rows="2" placeholder="Mag-iwan ng komento..." required></textarea>
            </div>
            <button type="submit" class="btn btn-sm btn-success">I-submit ang Komento</button>
        </form>
        {% elif request.session.role == "Magsasaka" %}
            <!-- Display notification for farmers who can't comment -->
            <p class="text-muted mt-2">Bilang magsasaka, hindi ka makakapag-iwan ng komento, ngunit maaari mong basahin ang mga komento ng eksperto.</p>
        {% endif %}
    </div>
    {% empty %}
        <p class="text-center">Walang mga post mula sa eksperto.</p>
    {% endfor %}
</div>

<!-- Styles (unchanged, just improved layout) -->
<style>
    .feed-container {
        max-width: 1000px;
        margin: auto;
    }
    
    .feed-post {
        border: 1px solid #ddd;
    }
    
    .post-header {
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
    }
    
    .post-profile {
        width: 50px;
        height: 50px;
        object-fit: cover;
        border: 2px solid #28a745;
    }
    
    .caption-text {
        white-space: pre-wrap;
    }
    
    .single-image {
        width: 100%;
        height: auto;
        max-height: 400px;
        object-fit: cover;
    }
    
    .multi-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
    }
    .upvote-button {
        transition: all 0.3s ease;
    }
    
    .comment-btn {
        display: inline-block;
        background-color:rgb(0, 66, 153); /* Bootstrap primary color */
        color: white;
        padding: 8px 16px;
        border-radius: 6px;
        text-decoration: none;
        font-weight: 500;
        transition: background-color 0.3s ease, box-shadow 0.2s ease;
    }
    
    .comment-btn:hover {
        background-color:rgb(25, 0, 138);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        text-decoration: none;
    }

<style>
/* Horizontal Scrollable Container */
.expert-scroll-container {
    overflow-x: auto;
    white-space: nowrap;
    padding: 10px;
    border-bottom: 2px solid #ddd;
}

/* Expert Card */
.expert-card {
    display: inline-block;
    margin: 0 10px;
    padding: 10px;
    text-align: center;
    position: relative;
}

/* Circular Profile */
.expert-profile {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 50%;
    border: 3px solid #28a745; /* Green for Approved */
    transition: transform 0.2s ease-in-out;
}

.expert-profile:hover {
    transform: scale(1.1);
}

/* Name & Position */
.expert-details {
    margin-top: 5px;
    font-size: 14px;
}

/* Verified Badge */
.verified-badge {
    position: absolute;
    top: 50px;
    right: 5px;
    background-color: #28a745;
    color: white;
    font-size: 14px;
    padding: 3px 6px;
    border-radius: 50%;
}
</style>

{% endblock %}
